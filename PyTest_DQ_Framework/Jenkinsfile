pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''
                    echo "=== Setting up Python Virtual Environment ==="

                    # Create virtual environment
                    python3 -m venv venv

                    # Activate
                    . venv/bin/activate

                    # Install from requirements.txt
                    pip install -r PyTest_DQ_Framework/requirements.txt

                    echo "Dependencies installed successfully"
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                            echo "=== Running DQE Tests ==="

                            # Activate virtual environment
                            . venv/bin/activate

                            # Go to framework directory
                            cd PyTest_DQ_Framework

                            # Create reports directory
                            mkdir -p reports

                            # Set environment variables for pytest
                            export DB_HOST=host.docker.internal
                            export DB_PORT=5434
                            export DB_NAME=mydatabase
                            export DB_USER=${DB_USER}
                            export DB_PASSWORD=${DB_PASSWORD}
                            export PARQUET_PATH=/parquet_data

                            # Run tests
                            python -m pytest tests/dq_checks/parquet_files/ -v \
                                --html=reports/test_report.html \
                                --self-contained-html \
                                --junitxml=reports/junit_results.xml
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            steps {
                sh '''
                    echo "=== Archiving Test Results ==="
                '''
                archiveArtifacts artifacts: 'PyTest_DQ_Framework/reports/*', fingerprint: true
                junit 'PyTest_DQ_Framework/reports/junit_results.xml'
            }
        }
    }

    post {
        always {
            sh '''
                echo "=== BUILD COMPLETED ==="
                echo "Job completed"
            '''
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}