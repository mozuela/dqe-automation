pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''
                    echo "=== Setting up Python Virtual Environment ==="
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install -r PyTest_DQ_Framework/requirements.txt
                    echo "Dependencies installed successfully"
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                            echo "=== Running DQE Tests ==="

                            . venv/bin/activate
                            cd PyTest_DQ_Framework
                            mkdir -p reports

                            # Run tests - capture exit code but don't fail pipeline
                            set +e
                            python -m pytest tests/dq_checks/parquet_files/ -v \
                                --db_host=host.docker.internal \
                                --db_port=5434 \
                                --db_name=mydatabase \
                                --db_user=${DB_USER} \
                                --db_password=${DB_PASSWORD} \
                                --html=reports/test_report.html \
                                --self-contained-html \
                                --junitxml=reports/junit_results.xml
                            TEST_EXIT_CODE=$?
                            set -e

                            echo ""
                            echo "=== TEST EXECUTION COMPLETED ==="
                            echo "Pytest exit code: ${TEST_EXIT_CODE}"
                            echo ""
                            echo "Reports generated:"
                            echo "- HTML Report: reports/test_report.html"
                            echo "- JUnit Report: reports/junit_results.xml"
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            steps {
                sh 'echo "Archiving test results..."'
                archiveArtifacts artifacts: 'PyTest_DQ_Framework/reports/*', fingerprint: true
                junit 'PyTest_DQ_Framework/reports/junit_results.xml'
            }
        }
    }

    post {
        always {
            sh '''
                echo "=== PIPELINE EXECUTION COMPLETED ==="
                echo "Job: ${JOB_NAME}"
                echo "Build: ${BUILD_NUMBER}"
                echo "Workspace: ${WORKSPACE}"
            '''
        }
    }
}