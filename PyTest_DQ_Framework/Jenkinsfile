pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    extensions: [],
                    userRemoteConfigs: [[url: 'https://github.com/mozuela/dqe-automation']]
                ])
            }
        }

        stage('Verify Structure') {
            steps {
                sh '''
                    echo "=== Verifying Project Structure ==="
                    echo "Current directory:"
                    pwd
                    ls -la

                    echo "Checking Python availability:"
                    python3 --version
                    python3 -m pip --version || echo "pip not available"

                    echo "Looking for requirements.txt:"
                    find . -name "requirements.txt" -type f

                    echo "Checking for PyTest framework directories:"
                    ls -la | grep -i pytest
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "=== Installing Dependencies ==="

                    echo "Checking for virtual environment..."
                    if [ ! -d "venv" ]; then
                        echo "Creating virtual environment..."
                        python3 -m venv venv
                    fi

                    echo "Activating virtual environment..."
                    source venv/bin/activate

                    echo "Upgrading pip in virtual environment..."
                    pip install --upgrade pip

                    echo "Installing dependencies..."
                    pip install pytest pandas psycopg2-binary pyarrow pytest-html

                    echo "Verifying installations..."
                    python -c "
                    import psycopg2
                    import pandas as pd
                    import pytest
                    import pyarrow
                    print('All critical imports successful')
                    "

                    deactivate
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                            echo "=== Running DQE Tests ==="
                            echo "PostgreSQL User: ${DB_USER}"

                            # Determine which directory to use
                            if [ -d "PyTest_DQ_Framework" ]; then
                                echo "Using PyTest_DQ_Framework directory"
                                FRAMEWORK_DIR="PyTest_DQ_Framework"
                            elif [ -d "PyTest DQ Framework" ]; then
                                echo "Using 'PyTest DQ Framework' directory"
                                FRAMEWORK_DIR="PyTest DQ Framework"
                            else
                                echo "ERROR: No PyTest framework directory found"
                                exit 1
                            fi

                            echo "Framework directory: ${FRAMEWORK_DIR}"

                            # Activate virtual environment
                            source venv/bin/activate

                            # Create reports directory
                            mkdir -p "${FRAMEWORK_DIR}/reports"

                            # Go to framework directory
                            cd "${FRAMEWORK_DIR}"

                            echo "Current directory:"
                            pwd
                            ls -la

                            echo "Test files found:"
                            find tests -name "test_*.py" -type f

                            # Determine parquet path
                            PARQUET_PATH=""
                            if [ -d "/parquet_data" ]; then
                                PARQUET_PATH="/parquet_data"
                            elif [ -d "../data_dev/parquet_data" ]; then
                                PARQUET_PATH="../data_dev/parquet_data"
                            elif [ -d "../../data_dev/parquet_data" ]; then
                                PARQUET_PATH="../../data_dev/parquet_data"
                            else
                                echo "Warning: No parquet directory found in standard locations"
                                echo "Will use current directory"
                                PARQUET_PATH="."
                            fi

                            echo "Using PARQUET_PATH: ${PARQUET_PATH}"
                            ls -la "${PARQUET_PATH}" 2>/dev/null || echo "Cannot list PARQUET_PATH"

                            echo "Running tests with command line arguments..."

                            # Run tests
                            python -m pytest tests/dq_checks/parquet_files/ -v \\
                                --db-host=host.docker.internal \\
                                --db-port=5434 \\
                                --db-name=mydatabase \\
                                --db-user=${DB_USER} \\
                                --db-password=${DB_PASSWORD} \\
                                --parquet-path="${PARQUET_PATH}" \\
                                --html="reports/dqe_report.html" \\
                                --self-contained-html \\
                                --junitxml="reports/junit_results.xml" || echo "Tests completed with some failures"

                            echo "Test execution finished"
                            deactivate
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            when {
                expression {
                    currentBuild.currentResult == null ||
                    currentBuild.currentResult == 'SUCCESS' ||
                    currentBuild.currentResult == 'UNSTABLE'
                }
            }
            steps {
                script {
                    // Determine framework directory
                    def frameworkDir = ""
                    if (fileExists('PyTest_DQ_Framework')) {
                        frameworkDir = 'PyTest_DQ_Framework'
                    } else if (fileExists('PyTest DQ Framework')) {
                        frameworkDir = 'PyTest DQ Framework'
                    }

                    if (frameworkDir && fileExists("${frameworkDir}/reports")) {
                        archiveArtifacts artifacts: "${frameworkDir}/reports/*", fingerprint: true
                        junit "${frameworkDir}/reports/junit_results.xml"
                        echo "Artifacts archived from ${frameworkDir}/reports/"
                    } else {
                        echo "No reports directory found to archive"
                    }
                }
            }
        }
    }

    post {
        always {
            sh '''
                echo "=== Pipeline completed ==="
                echo "Build completed"
                echo "Workspace contents:"
                pwd
                ls -la
            '''
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}