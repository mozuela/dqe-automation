pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    extensions: [],
                    userRemoteConfigs: [[
                        url: 'https://github.com/mozuela/dqe-automation'
                    ]]
                ])
            }
        }

        stage('Verify Structure') {
            steps {
                sh '''
                    echo "=== Verifying Project Structure ==="
                    echo "Current directory:"
                    pwd
                    ls -la
                    echo "Checking project structure:"
                    find . -type f -name "*.py" | head -20

                    if [ -d "PyTest DQ Framework" ]; then
                        cd "PyTest DQ Framework"
                        echo "Project structure in PyTest DQ Framework:"
                        find . -type f -name "*.py" | head -20
                        cd ..
                    fi
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "=== Installing Dependencies ==="

                    if [ -f "PyTest DQ Framework/requirements.txt" ]; then
                        echo "Found requirements.txt in PyTest DQ Framework/"
                        cd "PyTest DQ Framework"
                    elif [ -f "requirements.txt" ]; then
                        echo "Found requirements.txt in root"
                    else
                        echo "No requirements.txt found"
                    fi

                    python3 -m pip install --upgrade pip
                    python3 -m pip install pytest pandas psycopg2-binary pyarrow pytest-html

                    python3 -c "
                    import psycopg2
                    import pandas as pd
                    import pytest
                    import pyarrow
                    print('All critical imports successful')
                    "
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                            echo "=== Running DQE Tests ==="
                            echo "PostgreSQL User: ${DB_USER}"

                            mkdir -p reports

                            if [ -d "PyTest DQ Framework" ]; then
                                PROJECT_ROOT="PyTest DQ Framework"
                            else
                                PROJECT_ROOT="."
                            fi

                            cd "${PROJECT_ROOT}"

                            echo "Current directory for tests:"
                            pwd
                            ls -la

                            echo "Looking for test files:"
                            find . -name "test_*.py" -type f | head -10

                            if [ -d "tests/dq_checks/parquet_files" ]; then
                                echo "Found test directory: tests/dq_checks/parquet_files"
                                ls -la "tests/dq_checks/parquet_files/"
                            else
                                echo "Test directory not found"
                                find . -type d -name "*test*" -o -name "*dq*"
                            fi

                            PARQUET_PATH=""
                            if [ -d "/parquet_data" ]; then
                                PARQUET_PATH="/parquet_data"
                                echo "Using parquet data from: ${PARQUET_PATH}"
                            elif [ -d "parquet_data" ]; then
                                PARQUET_PATH="parquet_data"
                                echo "Using local parquet data from: ${PARQUET_PATH}"
                            elif [ -d "../parquet_data" ]; then
                                PARQUET_PATH="../parquet_data"
                                echo "Using parent parquet data from: ${PARQUET_PATH}"
                            else
                                echo "No parquet directory found"
                                PARQUET_PATH="./"
                            fi

                            if [ ! -f "pytest.ini" ]; then
                                echo "Creating pytest.ini configuration..."
                                cat > pytest.ini << EOF
[pytest]
testpaths = tests/dq_checks/parquet_files
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --tb=short
EOF
                            fi

                            echo "Running DQE tests..."

                            python3 -m pytest tests/dq_checks/parquet_files/ -v \\
                                --db-host=host.docker.internal \\
                                --db-port=5434 \\
                                --db-name=mydatabase \\
                                --db-user=${DB_USER} \\
                                --db-password=${DB_PASSWORD} \\
                                --parquet-path=${PARQUET_PATH} \\
                                --html=../reports/dqe_report.html \\
                                --self-contained-html \\
                                --junitxml=../reports/junit_results.xml || true

                            echo "Test execution completed"
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            when {
                expression { currentBuild.currentResult == null || currentBuild.currentResult == 'SUCCESS' || currentBuild.currentResult == 'UNSTABLE' }
            }
            steps {
                script {
                    if (fileExists('reports')) {
                        archiveArtifacts artifacts: 'reports/*', fingerprint: true
                        junit 'reports/junit_results.xml'
                    } else if (fileExists('PyTest DQ Framework/reports')) {
                        archiveArtifacts artifacts: 'PyTest DQ Framework/reports/*', fingerprint: true
                        junit 'PyTest DQ Framework/reports/junit_results.xml'
                    }
                }
            }
        }
    }

    post {
        always {
            sh '''
                echo "=== Pipeline completed ==="
                echo "Build Status: ${currentBuild.currentResult}"
                echo "Workspace contents:"
                ls -la

                if [ -d "reports" ]; then
                    echo "Reports directory:"
                    ls -la reports/
                fi
            '''
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}