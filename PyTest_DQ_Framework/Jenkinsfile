pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''
                    echo "=== Setting up Python Virtual Environment ==="
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install -r PyTest_DQ_Framework/requirements.txt
                    echo "Dependencies installed successfully"
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                            echo "=== Running DQE Tests ==="
                            echo "Test Parameters:"
                            echo "- Database Host: host.docker.internal"
                            echo "- Database Port: 5434"
                            echo "- Database Name: mydatabase"
                            echo "- Database User: ${DB_USER}"
                            echo "- Test Directory: tests/dq_checks/parquet_files/"

                            . venv/bin/activate
                            cd PyTest_DQ_Framework
                            mkdir -p reports

                            # Run tests and capture output
                            echo "Executing pytest..."
                            python -m pytest tests/dq_checks/parquet_files/ -v \
                                --db_host=host.docker.internal \
                                --db_port=5434 \
                                --db_name=mydatabase \
                                --db_user=${DB_USER} \
                                --db_password=${DB_PASSWORD} \
                                --html=reports/test_report.html \
                                --self-contained-html \
                                --junitxml=reports/junit_results.xml 2>&1 | tee test_output.log || true

                            # Generate simple summary
                            echo ""
                            echo "=== TEST EXECUTION COMPLETED ==="
                            echo "Check generated reports for details:"
                            echo "1. HTML Report: reports/test_report.html"
                            echo "2. JUnit Report: reports/junit_results.xml"
                            echo "3. Full Log: test_output.log"

                            # Simple file check
                            if [ -f "reports/test_report.html" ]; then
                                echo "HTML report generated successfully"
                            else
                                echo "WARNING: HTML report was not generated"
                            fi
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            steps {
                sh 'echo "Archiving test results..."'
                archiveArtifacts artifacts: 'PyTest_DQ_Framework/reports/*, PyTest_DQ_Framework/test_output.log', fingerprint: true
                junit 'PyTest_DQ_Framework/reports/junit_results.xml'
            }
        }
    }

    post {
        always {
            echo "Pipeline execution completed. Check artifacts for test results."
        }
    }
}