pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''
                    echo "=== Setting up Python Virtual Environment ==="

                    # Create virtual environment
                    python3 -m venv venv

                    # Activate (use . instead of source for compatibility)
                    . venv/bin/activate

                    # Install from requirements.txt
                    if [ -f "PyTest_DQ_Framework/requirements.txt" ]; then
                        echo "Installing from requirements.txt..."
                        pip install -r PyTest_DQ_Framework/requirements.txt
                    else
                        echo "Installing basic packages..."
                        pip install pytest pandas psycopg2-binary pyarrow pytest-html
                    fi

                    # Verify installation
                    python -c "import pytest; import pandas; import psycopg2; print('Dependencies installed successfully')"
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                            echo "=== Running DQE Tests ==="
                            echo "Database user: ${DB_USER}"

                            # Activate virtual environment
                            . venv/bin/activate

                            # Go to framework directory
                            cd PyTest_DQ_Framework

                            # Create reports directory
                            mkdir -p reports

                            # Run tests with parameters
                            python -m pytest tests/dq_checks/parquet_files/ -v \
                                --db-host=host.docker.internal \
                                --db-port=5434 \
                                --db-name=mydatabase \
                                --db-user=${DB_USER} \
                                --db-password=${DB_PASSWORD} \
                                --html=reports/test_report.html \
                                --self-contained-html \
                                --junitxml=reports/junit_results.xml

                            # Show test summary
                            echo "=== TEST EXECUTION COMPLETE ==="
                            echo "HTML report: reports/test_report.html"
                            echo "JUnit report: reports/junit_results.xml"
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            steps {
                sh '''
                    echo "=== Archiving Test Results ==="
                '''
                archiveArtifacts artifacts: 'PyTest_DQ_Framework/reports/*', fingerprint: true
                junit 'PyTest_DQ_Framework/reports/junit_results.xml'
            }
        }
    }

    post {
        always {
            sh '''
                echo "=== BUILD SUMMARY ==="
                echo "Job: ${JOB_NAME}"
                echo "Build Number: ${BUILD_NUMBER}"
                echo "Build Status: ${currentBuild.currentResult}"
                echo "Workspace: ${WORKSPACE}"
            '''
        }
        success {
            echo '✅ Pipeline executed successfully!'
        }
        failure {
            echo '❌ Pipeline failed!'
        }
    }
}