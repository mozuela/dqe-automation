pipeline {
    agent any

    environment {
        POSTGRES_CREDS = credentials('postgres-dqe')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh """
                # Install Python packages globally (for simplicity)
                pip3 install --user pytest pytest-html
                """
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'POSTGRES_USERNAME',
                            passwordVariable: 'POSTGRES_PASSWORD'
                        )
                    ]) {
                        def timestamp = sh(script: 'date +%Y%m%d_%H%M%S', returnStdout: true).trim()

                        sh """
                        # Create reports directory
                        mkdir -p reports

                        # Run tests
                        python3 -m pytest tests/dq_checks/ \
                            -v \
                            --html=reports/dqe_report_${timestamp}.html \
                            --self-contained-html
                        """
                    }
                }
            }
        }

        stage('Archive') {
            steps {
                archiveArtifacts artifacts: 'reports/*.html', fingerprint: true
            }
        }
    }
}