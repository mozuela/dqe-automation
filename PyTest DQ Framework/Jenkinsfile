pipeline {
    agent any

    environment {
        VENV_PATH = '/var/jenkins_home/venv'
        PYTHON_PATH = "${VENV_PATH}/bin/python"
        PIP_PATH = "${VENV_PATH}/bin/pip"
        PYTEST_PATH = "${VENV_PATH}/bin/pytest"
        PROJECT_DIR = "PyTest DQ Framework"
        REPORTS_DIR = "${WORKSPACE}/${PROJECT_DIR}/reports"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Verify Structure') {
            steps {
                sh '''
                echo "=== Verifying Project Structure ==="
                echo "Current directory:"
                pwd
                ls -la

                echo "Project directory: ${PROJECT_DIR}"
                ls -la "${PROJECT_DIR}" || echo "Project directory not found"

                if [ -d "${PROJECT_DIR}" ]; then
                    echo "Checking test files..."
                    ls -la "${PROJECT_DIR}/tests/dq checks/parquet_files/" || echo "Test files directory not found"
                fi
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                echo "=== Installing Dependencies ==="

                # Change to project directory
                cd "${PROJECT_DIR}"

                echo "Current directory for installation:"
                pwd

                echo "Requirements.txt content:"
                if [ -f "requirements.txt" ]; then
                    cat requirements.txt
                    echo "Installing dependencies from requirements.txt..."
                    ${PIP_PATH} install -r requirements.txt

                    echo "Verifying installations:"
                    ${PIP_PATH} list | grep -E "(pytest|pandas|psycopg|pyarrow)" || echo "No matching packages found"
                else
                    echo "ERROR: requirements.txt not found!"
                    exit 1
                fi

                # Test critical imports
                echo "Testing critical imports..."
                ${PYTHON_PATH} -c "
try:
    import psycopg2
    print('✅ psycopg2 import successful')
except ImportError as e:
    print(f'❌ psycopg2 import failed: {e}')

try:
    import pandas
    print('✅ pandas import successful')
except ImportError as e:
    print(f'❌ pandas import failed: {e}')

try:
    import pytest
    print('✅ pytest import successful')
except ImportError as e:
    print(f'❌ pytest import failed: {e}')
                "
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'POSTGRES_USER',
                            passwordVariable: 'POSTGRES_PASS'
                        )
                    ]) {
                        sh '''
                        echo "=== Running DQE Tests ==="
                        echo "PostgreSQL User: ${POSTGRES_USER}"

                        # Change to project directory
                        cd "${PROJECT_DIR}"

                        # Create reports directory
                        mkdir -p "${REPORTS_DIR}"

                        echo "Running 3 DQE tests from tests/dq checks/parquet_files/"

                        # Execute the 3 specific parquet tests
                        ${PYTEST_PATH} "tests/dq checks/parquet_files/" \
                            -v \
                            --html="${REPORTS_DIR}/dqe_report.html" \
                            --self-contained-html \
                            --junitxml="${REPORTS_DIR}/junit_results.xml"

                        # Check results
                        TEST_EXIT_CODE=$?
                        echo "Pytest exit code: ${TEST_EXIT_CODE}"

                        # Create summary file
                        echo "=== DQE TEST EXECUTION SUMMARY ===" > "${REPORTS_DIR}/execution_summary.txt"
                        echo "Execution time: $(date)" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Project directory: ${PROJECT_DIR}" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Test directory: tests/dq checks/parquet_files/" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Pytest exit code: ${TEST_EXIT_CODE}" >> "${REPORTS_DIR}/execution_summary.txt"

                        # List executed test files
                        echo "" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Test files executed:" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "1. test_facility_name_min_time_spent_per_visit_date.py" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "2. test_facility_type_avg_time_spent_per_visit_date.py" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "3. test_patient_sum_treatment_cost_per_facility_type.py" >> "${REPORTS_DIR}/execution_summary.txt"

                        echo "" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "=== Summary created ===" >> "${REPORTS_DIR}/execution_summary.txt"
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            steps {
                sh '''
                echo "=== Archiving Results ==="
                echo "Reports directory: ${REPORTS_DIR}"

                if [ -d "${REPORTS_DIR}" ]; then
                    echo "Found reports:"
                    ls -la "${REPORTS_DIR}"
                else
                    echo "No reports directory found"
                fi
                '''

                archiveArtifacts artifacts: 'PyTest DQ Framework/reports/*.html, PyTest DQ Framework/reports/*.xml, PyTest DQ Framework/reports/*.txt', fingerprint: true

                publishHTML([
                    target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: 'PyTest DQ Framework/reports',
                        reportFiles: 'dqe_report.html',
                        reportName: 'DQE Test Report'
                    ]
                ])
            }
        }
    }

    post {
        always {
            sh '''
            echo "=== Pipeline completed ==="
            echo "Final status: ${currentBuild.currentResult}"
            echo "Build Number: ${BUILD_NUMBER}"
            '''
        }
    }
}