pipeline {
    agent any

    stages {
        stage('Declarative: Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    extensions: [],
                    userRemoteConfigs: [[url: 'https://github.com/mozuela/dqe-automation']]
                ])
            }
        }

        stage('Verify Structure') {
            steps {
                sh '''
                    echo "=== Verifying Project Structure ==="
                    echo "Current directory:"
                    pwd
                    ls -la
                    echo "Checking /parquet_data directory:"
                    ls -la /parquet_data/ || echo "/parquet_data not found, will use alternative path"
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "=== Installing Dependencies ==="
                    cd "PyTest DQ Framework"
                    if [ -f requirements.txt ]; then
                        echo "Installing dependencies..."
                        /var/jenkins_home/venv/bin/pip install -r requirements.txt
                    fi
                    echo "Testing critical imports..."
                    /var/jenkins_home/venv/bin/python -c "
                    import psycopg2
                    import pandas
                    import pytest
                    print('âœ… All critical imports successful')
                    "
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                            echo "=== Running DQE Tests ==="
                            echo "PostgreSQL User: ${DB_USER}"

                            cd "PyTest DQ Framework"

                            # Create reports directory
                            mkdir -p /var/jenkins_home/workspace/DQE_Aut/PyTest\ DQ\ Framework/reports

                            # Determine parquet path - use /parquet_data if it exists
                            if [ -d "/parquet_data" ]; then
                                PARQUET_PATH="/parquet_data"
                                echo "Using parquet data from: ${PARQUET_PATH}"
                                find ${PARQUET_PATH} -name "*.parquet" | head -3
                            else
                                PARQUET_PATH="/var/jenkins_home/workspace/DQE_Aut/data_dev/parquet_data"
                                echo "Using parquet data from: ${PARQUET_PATH}"
                                mkdir -p ${PARQUET_PATH}
                            fi

                            echo "Running 3 DQE tests with PostgreSQL credentials..."

                            /var/jenkins_home/venv/bin/pytest tests/dq\ checks/parquet_files/ -v \
                                --db_host=host.containers.internal \
                                --db_port=5434 \
                                --db_name=mydatabase \
                                --db_user=${DB_USER} \
                                --db_password=${DB_PASSWORD} \
                                --parquet_path=${PARQUET_PATH} \
                                --html=/var/jenkins_home/workspace/DQE_Aut/PyTest\ DQ\ Framework/reports/dqe_report.html \
                                --self-contained-html \
                                --junitxml=/var/jenkins_home/workspace/DQE_Aut/PyTest\ DQ\ Framework/reports/junit_results.xml
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                archiveArtifacts artifacts: 'PyTest DQ Framework/reports/*', fingerprint: true
                junit 'PyTest DQ Framework/reports/junit_results.xml'
            }
        }
    }

    post {
        always {
            sh '''
                echo "=== Pipeline completed ==="
                echo "Build Status: ${currentBuild.result}"
                echo "Workspace: ${WORKSPACE}"
            '''
        }
        success {
            echo 'Pipeline executed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}