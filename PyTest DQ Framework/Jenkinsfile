pipeline {
    agent any

    environment {
        VENV_PATH = '/var/jenkins_home/venv'
        PYTHON_PATH = "${VENV_PATH}/bin/python"
        PIP_PATH = "${VENV_PATH}/bin/pip"
        PYTEST_PATH = "${VENV_PATH}/bin/pytest"
        PROJECT_DIR = "PyTest DQ Framework"
        REPORTS_DIR = "${WORKSPACE}/${PROJECT_DIR}/reports"

        // PostgreSQL connection settings
        DB_HOST = "host.containers.internal"  // For Podman
        DB_PORT = "5434"
        DB_NAME = "mydatabase"
        PARQUET_PATH = "/var/jenkins_home/workspace/DQE_Aut/data_dev/parquet_data"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Verify Structure') {
            steps {
                sh '''
                echo "=== Verifying Project Structure ==="
                echo "Current directory:"
                pwd
                ls -la

                echo "Checking parquet data directory:"
                ls -la "${PARQUET_PATH}" || echo "Parquet directory not found, will create if needed"
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                echo "=== Installing Dependencies ==="
                cd "${PROJECT_DIR}"

                if [ -f "requirements.txt" ]; then
                    echo "Installing dependencies..."
                    ${PIP_PATH} install -r requirements.txt

                    echo "Testing critical imports..."
                    ${PYTHON_PATH} -c "
import psycopg2
import pandas
import pytest
print('âœ… All critical imports successful')
                    "
                fi
                '''
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'DB_USER',
                            passwordVariable: 'DB_PASSWORD'
                        )
                    ]) {
                        sh '''
                        echo "=== Running DQE Tests ==="
                        echo "PostgreSQL User: ${DB_USER}"

                        # Change to project directory
                        cd "${PROJECT_DIR}"

                        # Create reports directory
                        mkdir -p "${REPORTS_DIR}"

                        # Create parquet directory if it doesn't exist
                        mkdir -p "${PARQUET_PATH}" || true

                        echo "Running 3 DQE tests with PostgreSQL credentials..."

                        # Execute tests with all required arguments
                        ${PYTEST_PATH} "tests/dq checks/parquet_files/" \
                            -v \
                            --db_host="${DB_HOST}" \
                            --db_port="${DB_PORT}" \
                            --db_name="${DB_NAME}" \
                            --db_user="${DB_USER}" \
                            --db_password="${DB_PASSWORD}" \
                            --parquet_path="${PARQUET_PATH}" \
                            --html="${REPORTS_DIR}/dqe_report.html" \
                            --self-contained-html \
                            --junitxml="${REPORTS_DIR}/junit_results.xml"

                        # Check results
                        TEST_EXIT_CODE=$?
                        echo "Pytest exit code: ${TEST_EXIT_CODE}"

                        # Create summary file
                        echo "=== DQE TEST EXECUTION SUMMARY ===" > "${REPORTS_DIR}/execution_summary.txt"
                        echo "Execution time: $(date)" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Project directory: ${PROJECT_DIR}" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Test directory: tests/dq checks/parquet_files/" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "PostgreSQL Host: ${DB_HOST}:${DB_PORT}" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Database: ${DB_NAME}" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Pytest exit code: ${TEST_EXIT_CODE}" >> "${REPORTS_DIR}/execution_summary.txt"

                        echo "" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "Test files executed:" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "1. test_facility_name_min_time_spent_per_visit_date.py" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "2. test_facility_type_avg_time_spent_per_visit_date.py" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "3. test_patient_sum_treatment_cost_per_facility_type.py" >> "${REPORTS_DIR}/execution_summary.txt"

                        echo "" >> "${REPORTS_DIR}/execution_summary.txt"
                        echo "=== Summary saved to ${REPORTS_DIR}/execution_summary.txt ==="
                        '''
                    }
                }
            }
        }

        stage('Archive Results') {
            steps {
                sh '''
                echo "=== Archiving Results ==="
                echo "Reports directory: ${REPORTS_DIR}"

                if [ -d "${REPORTS_DIR}" ]; then
                    echo "Found reports:"
                    ls -la "${REPORTS_DIR}"
                fi
                '''

                archiveArtifacts artifacts: 'PyTest DQ Framework/reports/*.html, PyTest DQ Framework/reports/*.xml, PyTest DQ Framework/reports/*.txt', fingerprint: true

                publishHTML([
                    target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: 'PyTest DQ Framework/reports',
                        reportFiles: 'dqe_report.html',
                        reportName: 'DQE Test Report'
                    ]
                ])
            }
        }
    }

    post {
        always {
            sh '''
            echo "=== Pipeline completed ==="
            echo "Status: ${currentBuild.currentResult}"
            echo "Build: ${env.BUILD_NUMBER}"
            '''
        }
    }
}