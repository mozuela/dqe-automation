pipeline {
    agent any

    environment {
        POSTGRES_CREDS = credentials('postgres-dqe')
        WORKSPACE_DIR = "${env.WORKSPACE}"
        VENV_PATH = "${env.WORKSPACE}/venv"
        REPORTS_DIR = "${env.WORKSPACE}/reports"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                sh """
                python3 -m venv ${VENV_PATH}
                source ${VENV_PATH}/bin/activate
                pip install --upgrade pip
                pip install -r requirements.txt
                pip install pytest pytest-html
                mkdir -p ${REPORTS_DIR}
                """
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withEnv([
                        "PATH+VENV=${VENV_PATH}/bin",
                        "POSTGRES_USERNAME=${POSTGRES_CREDS_USR}",
                        "POSTGRES_PASSWORD=${POSTGRES_CREDS_PSW}"
                    ]) {
                        def timestamp = sh(script: 'date +%Y%m%d_%H%M%S', returnStdout: true).trim()

                        sh """
                        source ${VENV_PATH}/bin/activate

                        # Execute your 3 specific DQE tests
                        pytest tests/dq_checks/ \
                            test_facility_name_min_time_spent_per_visit_date.py \
                            test_facility_type_avg_time_spent_per_visit_date.py \
                            test_patient_sum_treatment_cost_per_facility_type.py \
                            -v \
                            --html=${REPORTS_DIR}/dq_summary_${timestamp}.html \
                            --self-contained-html
                        """
                    }
                }
            }
        }

        stage('Archive') {
            steps {
                archiveArtifacts artifacts: 'reports/*.html', fingerprint: true
                publishHTML([
                    target: [
                        reportDir: 'reports',
                        reportFiles: 'dq_summary_*.html',
                        reportName: 'DQE Summary Report'
                    ]
                ])
            }
        }
    }

    post {
        always {
            sh "rm -rf ${VENV_PATH} || true"
        }
    }
}