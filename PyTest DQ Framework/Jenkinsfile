pipeline {
    agent any

    environment {
        VENV_PATH = '/var/jenkins_home/venv'
        PYTHON_PATH = "${VENV_PATH}/bin/python"
        PYTEST_PATH = "${VENV_PATH}/bin/pytest"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Run DQE Tests') {
            steps {
                script {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'postgres-dqe',
                            usernameVariable: 'POSTGRES_USER',
                            passwordVariable: 'POSTGRES_PASS'
                        )
                    ]) {
                        sh '''
                        echo "=== Running DQE Tests ==="

                        # Change to project directory
                        cd "PyTest DQ Framework"

                        # Create reports directory
                        mkdir -p reports

                        # Run the 3 specific tests
                        ${PYTEST_PATH} "tests/dq checks/parquet_files/test_facility_name_min_time_spent_per_visit_date.py" \
                            "tests/dq checks/parquet_files/test_facility_type_avg_time_spent_per_visit_date.py" \
                            "tests/dq checks/parquet_files/test_patient_sum_treatment_cost_per_facility_type.py" \
                            -v \
                            --html=reports/dqe_report.html \
                            --self-contained-html

                        echo "=== Tests completed ==="
                        '''
                    }
                }
            }
        }

        stage('Archive') {
            steps {
                archiveArtifacts artifacts: 'PyTest DQ Framework/reports/*.html', fingerprint: true
            }
        }
    }
}